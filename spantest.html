<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Enchanted Contenteditable Span</title>
</head>

<body>
  <div data-lined-form-container data-lined-form-container-oi3h1rb2fwelkjnklger213 style="width: 250px;">

    <style>
      [data-lined-form-container-oi3h1rb2fwelkjnklger213] {
        width: 200px;
        position: relative;
      }

      [data-lined-form-container-oi3h1rb2fwelkjnklger213] [data-lined-form-back-touch-detector] {
        width: 100%;
        height: 100%;
      }

      [data-header], 
      [data-footer] {
        background: white;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        box-sizing: content-box;
        z-index: 1;
      }
      [data-footer] {
        position: absolute;
        bottom: 0;
        left: 100%;
      }
    </style>
      
    <div data-lined-form-back-touch-detector></div>
    <div data-lined-form-text-content>
      <div data-lined-form-span-holder style="width: 100%; height: 100%; position: relative;"></div>
      <span data-initial-span></span>
      <span data-header><strong>Sandy is a&nbsp;</strong></span>
      <span data-lined-form-content-editable contenteditable="plaintext-only" style="white-space: pre-wrap; outline: none; line-height: 1;"></span>
      <span data-footer><strong>&nbsp;.&nbsp;</strong></span>
    </div>

    <script>

      const createRange = (node, targetPosition) => {
        let range = document.createRange();
        range.selectNode(node);
        range.setStart(node, 0);
    
        let pos = 0;
        const stack = [node];
        while (stack.length > 0) {
            const current = stack.pop();
    
            if (current.nodeType === Node.TEXT_NODE) {
                const len = current.textContent.length;
                if (pos + len >= targetPosition) {
                    range.setStart(current, targetPosition - pos - 1);
                    range.setEnd(current, targetPosition - pos - 1);
                    return range;
                }
                pos += len;
            } else if (current.childNodes && current.childNodes.length > 0) {
                for (let i = current.childNodes.length - 1; i >= 0; i--) {
                    stack.push(current.childNodes[i]);
                }
            }
        }
    
        // The target position is greater than the
        // length of the contenteditable element.
        range.setStart(node, node.childNodes.length);
        range.setEnd(node, node.childNodes.length);
        return range;
      };

      const checkcaret = ((e) => {
        const selection = document.getSelection();
        if (selection && selection.anchorNode) {
          if (selection.anchorNode === e.target) {
            e.target.pastAnchorOffset = e.target.textContent.length;
          } else if (selection.anchorNode.parentElement === e.target) {
            e.target.pastAnchorOffset = selection.anchorOffset;
          }
        }
      })

      const detectNonCondensedSpaces = (inputString) => {
        // Use a regular expression to find instances of two or more consecutive spaces
        let nonCondensedSpaces = inputString.match(/\s{2,}/g);
    
        // Display the non-condensed spaces found in the string
        if (nonCondensedSpaces) {
            console.log('Non-Condensed Spaces Detected:');
            return true;
        } else {
            console.log('No non-condensed spaces found in the string.');
        }
    
        return false;
      }

      const condenseSpaces = (inputString) => {
        // Use a regular expression to replace multiple spaces with a single space
        let condensedString = inputString
        .replace(/\n/g, '')
        .replace(/\s{2,}/g, ' ');
    
        // Display the modified string
        console.log('Original String:', inputString);
        console.log('Condensed String:', condensedString);
    
        return condensedString;
      }
    
      document.querySelector('[data-lined-form-content-editable]').addEventListener('keypress', checkcaret); // Every character written
      document.querySelector('[data-lined-form-content-editable]').addEventListener('mousedown', checkcaret); // Click down
      document.querySelector('[data-lined-form-content-editable]').addEventListener('touchstart', checkcaret); // Mobile
      document.querySelector('[data-lined-form-content-editable]').addEventListener('input', checkcaret); // Other input events
      document.querySelector('[data-lined-form-content-editable]').addEventListener('paste', checkcaret); // Clipboard actions
      document.querySelector('[data-lined-form-content-editable]').addEventListener('cut', checkcaret);
      document.querySelector('[data-lined-form-content-editable]').addEventListener('mousemove', checkcaret); // Selection, dragging text
      document.querySelector('[data-lined-form-content-editable]').addEventListener('select', checkcaret); // Some browsers support this event
      document.querySelector('[data-lined-form-content-editable]').addEventListener('selectstart', checkcaret); // Some browsers support this event

      document.querySelector('[data-lined-form-content-editable]').addEventListener('paste', (e) => {
        const pastedText = condenseSpaces(e.clipboardData.getData('text'));
        e.preventDefault();

        const maxVacantLength = Math.max(0, 100 - e.target.textContent.length);
        const trimmedPastedText = pastedText.length > maxVacantLength ? pastedText.substring(0, maxVacantLength) : pastedText;

        const startIdx = e.target.pastAnchorOffset || 0;
        const strOld = e.target.textContent || '';

        const strNew = strOld.slice(0, startIdx) + trimmedPastedText + strOld.slice(startIdx, strOld.length);
        e.target.textContent = condenseSpaces(strNew);

        document.getSelection().removeAllRanges();
        document.getSelection().addRange(createRange(e.target, e.target.pastAnchorOffset + trimmedPastedText.length + 1));

        e.target.pastInnerHTML = e.target.innerHTML;

        checkcaret(e);
      });

      document.querySelector('[data-lined-form-content-editable]').addEventListener('input', (e) => {
        
        if (detectNonCondensedSpaces(e.target.textContent)) {
          e.target.textContent = condenseSpaces(e.target.textContent);
          document.getSelection().removeAllRanges();
          document.getSelection().addRange(createRange(e.target, e.target.pastAnchorOffset));
        }

        if (e.target.innerHTML.length > 100) {
          e.target.innerHTML = e.target.pastInnerHTML;
          document.getSelection().removeAllRanges();
          document.getSelection().addRange(createRange(e.target, e.target.pastAnchorOffset));
        }
        e.target.pastInnerHTML = e.target.innerHTML;
        checkcaret(e);
      });

      
      // Select the specific DOM element you wish to observe
      const targetElement = document.querySelector('[data-lined-form-content-editable]'); // Replace 'yourElementId' with the actual ID of the element

      // Create a new MutationObserver to watch for changes in the element
      const observer = new MutationObserver((mutationsList) => {
          for (let mutation of mutationsList) {
              console.log('Text/Content changed:', targetElement.innerHTML, targetElement.innerHTML.match(/<br\s*\/?>/gi), targetElement.innerHTML.length);

              if (targetElement.innerHTML.match(/\n/gi)) {
                targetElement.innerHTML = targetElement.innerHTML.replace(/\n/gi, '');
              }

          }
      });

      // Configure the observer to watch for childList and characterData changes
      const config = { childList: true, characterData: true };

      // Start observing the target element for changes
      observer.observe(targetElement, config);
      
    </script>
<!-- 
    <script>
      document.querySelector("[data-lined-form-container-oi3h1rb2fwelkjnklger213]").on('focusin', function() {
        // your code here
      });
      focus(textInput){
        const length = textInput.innerText.length;
        textInput.focus();
    
        if(!!textInput.lastChild){
          const sel = window.getSelection();
          sel.collapse(textInput.lastChild, length);
        }
      }
    </script> -->

    <script>
      document.querySelectorAll("[data-lined-form-container-oi3h1rb2fwelkjnklger213] [data-lined-form-text-content]").forEach((it) => {
        const initialSpan = it.querySelector("[data-initial-span]");
        const style = window.getComputedStyle(initialSpan);
        const exactLineHeight = initialSpan.offsetHeight;
        it.style.background = `url(data:image/svg+xml;charset=utf-8,${encodeURIComponent(`<svg height="${exactLineHeight}" width="1" xmlns="http://www.w3.org/2000/svg"><line x1="0" y1="${exactLineHeight}" x2="1" y2="${exactLineHeight}" style="stroke:black;stroke-width:2.0" /></svg>`)})`;
      })
    </script>
  </div>
</body>
</html>